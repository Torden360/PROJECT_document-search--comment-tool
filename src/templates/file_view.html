{% extends 'base.html' %}

{% block title %}Viewing: {{file.name}}{% endblock %}

{% block bodycontent %}
<div id="search">
    <form id="search_bar" action="/search_view">
        <input id="search_bar" type="text" name="search_phrase" placeholder="Search">
        <input type="text" name="doc_id" value="{{file.document_id}}" hidden>
        <input type="submit" hidden>
    </form>
</div>

<script>
    // Alert group notes were saved

    // select save button
    const groupSaveBtn = document.querySelector('#save_matches_button');
    
    function saveMatchData() {

        console.log('This is saveMatchData!')

        const matchData = {};

        // select matches that have not been x'd out 
        // can now index into this array of objects
        const matches = document.querySelectorAll('.matches');

        // get search_id and put into dictionary
        matchData['search_id'] = document.getAttribute('data-search-id');

        matchData['matches'] = [];

        for (let i = 0; i < matches.length; i++) {

            console.log("Attr names: ", matches[i].getAttributeNames(), "Attributes: ", 
                        matches[i].getAttribute("data-start"));

            // get content of match notes
 
            matchData['matches'].push({
                'content': matches[i].innerText,

                // get start_offset
                'start_offset': matches[i].getAttribute('data-start'),
            
                // get end_offset of matches
                'end_offset': matches[i].getAttribute('data-end'),
            });

            // get match note value and determine if user has written notes
            // if matches[i].childNodes[3].value > matches[i].childNodes[3].defaultValue {
            //     matchData['Notes'] = matches[i].childNodes[3].value;
            // }
        }

        // post method to /save_grouped_matches with Fetch
        fetch('/save_grouped_matches', {
            method: 'POST',
            body: JSON.stringify(matchData)
        })
        .then(response => response.json())
        .then(response => console.log('Success:', JSON.stringify(response)))
        .catch(error => console.error('Error:', error));
    }

    // add onclick listener
    groupSaveBtn.addEventListener('click', saveMatchData);

</script>
<div class="container">
    <p id="file">
{{text}}
    </p>

    <div class="match_container" data-search-id="{{search_id}}">
        {% if matches %}
            {% for match in matches %}
            <div class="matches" data-start="{{match_start}}match_start" data-end="{{match_end}}">
                <label> {{match}} </label>
                <textarea class="notes" row="10" col="50">Note: </textarea>
            </div>
            {% endfor %}
            <button id="save_matches_button" value="Save">
        {% endif %}
        
        {% if not matches %}
        No match results found.
        {% endif %}
    </div>

</div>


{% endblock %}